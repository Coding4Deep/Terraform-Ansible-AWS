- name: Fetch Vault secrets as facts
  set_fact:
    tomcat_creds: "{{ lookup('community.hashi_vault.hashi_vault', 'secret=tomcat/data/creds kv_version=2 auth_method=token token=' + lookup('env','VAULT_TOKEN') + ' url=' + lookup('env','VAULT_ADDR')) }}"

- name: Set tomcat_username and tomcat_password
  set_fact:
    tomcat_username: "{{ tomcat_creds.username }}"
    tomcat_password: "{{ tomcat_creds.password }}"

- name: Debug tomcat credentials
  debug:
    msg: "Username: {{ tomcat_username }}, Password: {{ tomcat_password }}"

- name: Copy tomcat-users.xml with credentials from Vault
  template:
    src: tomcat-users.xml.j2
    dest: "{{ tomcat_install_dir }}/conf/tomcat-users.xml"
    owner: "{{ tomcat_user }}"
    group: "{{ tomcat_user }}"
    mode: '0644'

- name: Allow remote access to manager app
  replace:
    path: "{{ tomcat_install_dir }}/webapps/manager/META-INF/context.xml"
    regexp: '<Valve className="org.apache.catalina.valves.RemoteAddrValve"[^>]+/>'
    replace: '<!-- RemoteAddrValve removed by Ansible for remote access -->'

- name: Allow remote access to host-manager app
  replace:
    path: "{{ tomcat_install_dir }}/webapps/host-manager/META-INF/context.xml"
    regexp: '<Valve className="org.apache.catalina.valves.RemoteAddrValve"[^>]+/>'
    replace: '<!-- RemoteAddrValve removed by Ansible for remote access -->'